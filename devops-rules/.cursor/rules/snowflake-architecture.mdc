---
description: Snowflake Infrastructure, Security, and Account Object Management Rules
globs: **/*.tf, **/*.sql, **/snowflake/*.yml, **/*.bicep
---

# Snowflake Infrastructure & Account Standards

These rules define the foundational architecture and infrastructure standards for Snowflake environments. They focus on **Account Object Management**, **Security Implementation**, and **Infrastructure as Code (IaC)**.

For *logical data modeling* rules (tables, columns, dbt conventions), refer to `dbt-datamodelling-snowflake.mdc`.

## 1. Account Object Architecture

### 1.1 Resource Hierarchy
Manage resources using a strict hierarchy to ensure isolation and security.

*   **Databases**: Align with Environment and Project (e.g., `PROD_ANALYTICS_DB`).
*   **Schemas**: Align with the Medallion Architecture (`RAW`, `PREPARE`, `ANALYZE`).
*   **Warehouses**: Workload-specific sizing (e.g., `LOAD_WH`, `TRANSFORM_WH`).

### 1.2 Warehouse Strategy
Isolate workloads to prevent resource contention and optimize costs.

| Warehouse | Size Strategy | Auto-Suspend | Workload Type |
| :--- | :--- | :--- | :--- |
| **LOAD_WH** | X-Small | 60s | Fivetran, Snowpipe, Kafka (Continuous Loading) |
| **TRANSFORM_WH** | Small/Medium | 300s | dbt models, Stored Procs (Heavy Compute) |
| **ANALYTICS_WH** | Medium/Large | 600s | BI Tools, Ad-hoc Queries (User Concurrency) |
| **ADMIN_WH** | X-Small | 60s | Terraform, Tagging, User Mgmt (Light Ops) |

### 1.3 Database Physical Configuration
*   **Time Travel**:
    *   `RAW`: **1 day** (Transient data, easily reloadable).
    *   `PREPARE`: **1-7 days** (Transformation history).
    *   `ANALYZE`: **7-90 days** (Critical business data recovery).
*   **Fail-safe**: Standard 7 days for all Permanent tables.
*   **Zero-Copy Cloning**: Use cloning for `DEV`/`QA` environments from `PROD` data to save storage costs.

## 2. Security Architecture

### 2.1 RBAC (Role-Based Access Control)
Implement a simplified inheritance model separating **Function** from **Access**.

#### Functional Roles (What you do)
*   `READER` (Read-only) -> `WRITER` (Read+Write) -> `ADMIN` (DDL/Grant) -> `SYSADMIN`.
*   **Naming**: `{ENV}_{PROJECT}_{ROLE}_ROLE` (e.g., `PROD_SALES_READER_ROLE`).

#### Access Roles (What you see)
*   `INGEST_ONLY`: `RAW` schema access.
*   `ANALYZE_ONLY`: `ANALYZE` schema access.
*   `ALL_DATA`: Full database access.

### 2.2 Authentication & Network
*   **Humans (`TYPE=PERSON`)**:
    *   **MFA**: MANDATORY for all human users.
    *   **SSO**: Prefer SAML (Okta/Azure AD) over passwords.
*   **Services (`TYPE=SERVICE`)**:
    *   **Key-Pair Auth**: MANDATORY. Rotate keys every 90 days.
    *   **Passwords**: FORBIDDEN for service accounts.
*   **Network Policies**:
    *   **Default**: `DENY ALL`.
    *   **Allowlist**: Corporate VPN, CI/CD Runners, ETL IPs (Fivetran).

### 2.3 Data Protection
*   **Masking Policies**: Apply Dynamic Data Masking (DDM) to PII columns (`email`, `ssn`) at the schema level.
*   **Row Access Policies**: Use for multi-tenant data separation if required.

## 3. Infrastructure as Code (Terraform)

All Snowflake Account Objects must be managed via Terraform.

### 3.1 State Management
*   **Remote State**: Use S3/Azure Blob with state locking.
*   **Isolation**: Separate state files per environment (`dev.tfstate`, `prod.tfstate`).

### 3.2 Resource Naming Conventions
*   **Terraform Resource**: `snowflake_database.analytics_prod` (snake_case).
*   **Snowflake Object**: `PROD_ANALYTICS_DB` (UPPER_CASE).

### 3.3 Tagging Strategy
Apply tags at the **Account** or **Database** level for cost attribution.
*   `ENVIRONMENT`: `dev`, `prod`
*   `COST_CENTER`: `finance`, `marketing`
*   `OWNER`: `data-engineering`

## 4. Checklist for New Infrastructure

- [ ] Is the Warehouse sized correctly for the workload?
- [ ] Is Time Travel configured based on data criticality?
- [ ] Are Service Users using Key-Pair authentication?
- [ ] Is a Network Policy attached to the User/Account?
- [ ] Are all resources defined in Terraform?
- [ ] Are PII columns protected with Masking Policies?
